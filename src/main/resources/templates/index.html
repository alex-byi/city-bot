<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bot Web Service</title>
    <script src="https://cdn.jsdelivr.net/npm/vue"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css"
          integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
    <script src='https://kit.fontawesome.com/a076d05399.js'></script>
    <script>
    function disp(tr) {
        if (tr.style.display == "none") {
            tr.style.display = "block";
        } else {
            tr.style.display = "none";
        }
    }
    </script>
</head>
<body>

<div id="cities">

    <div class="fixed-top">
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <a class="navbar-brand" href="/">Cities for telegram bot</a>

            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">All cities</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="disp(document.getElementById('tr1'))">Add city</a>
                    </li>
                </ul>
            </div>
        </nav>
    </div>
    <br>
    <br>
    <br>
    <br>
    <div v-if="error">
        <font size="5" color="red" face="Arial">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! {{ error }}
            !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</font>
    </div>

    <div>
        <table class="table table-striped table-bordered" id="tr1" style="display: none;">
            <tr>
                <td>City <input type="text" v-model="newCityName"/></td>
                <td>Message <input type="text" v-model="newCityMessage"/></td>
                <td><button type="submit" class="btn btn-sm btn-outline-primary" @click="addNewCity()">Add new city</button></td>
            </tr>
        </table>
        <table class="table table-striped table-bordered">
            <thead>
            <tr>
                <th>id</th>
                <th>city</th>
                <th>message</th>
            </tr>
            </thead>

            <tbody>
            <tr v-for="city in cities">
                <td>
                    <div>
                        {{ city.id }}
                        <i class="fa fa-trash" @click="deleteCity(city)"></i>
                    </div>
                </td>
                <td>
                    <div v-if="!editingCity">
                        {{ city.city }}
                        <i class='far fa-edit' @click="editCityEnter(city)"></i>
                    </div>
                    <div v-if="editingCity">
                        <input v-model="city.city" type="text" placeholder="Please input city">
                        <button class="primary" @click="editCitySave(city)">OK</button>
                        <button class="secondary" @click="editCityCancel(city)">Cancel</button>
                    </div>
                </td>
                <td>
                    <div v-if="!editingMessage">
                        {{ city.message }}
                        <i class='far fa-edit' @click="editMessageEnter(city)"></i>
                    </div>
                    <div v-if="editingMessage">
                        <input v-model="city.message" type="text" placeholder="Please input message">
                        <button class="primary" @click="editMessageSave(city)">OK</button>
                        <button class="secondary" @click="editMessageCancel(city)">Cancel</button>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

</div>


<script>
new Vue({
    el: '#cities',
    data: {
        cities: null,
        cityName: null,
        editingCity: false,
        editingMessage: false,
        oldCity: '',
        oldMessage: '',
        error: null,
        cityId: null,
        newCityName: '',
        newCityMessage: ''
    },
    mounted: function(){
        this.getAllCities();
    },
    methods: {
        getAllCities: function() {
            let currApp = this;
            axios.get(`/cities`)
            .then(function (response) {
                currApp.cities = response.data;
            })
        },
        getCityByName: function() {
            let currApp = this;
            console.log(currApp.cityName);
            axios.get(`/cities/${currApp.cityName}`)
            .then(function (response) {
                currApp.cities = response;
            })
        },
        addNewCity: function() {
            let currApp = this;
            console.log(currApp.newCityName);
            console.log(currApp.newCityMessage);
            axios.post(`/cities`, {
                city: currApp.newCityName,
                message: currApp.newCityMessage
            })
            .then(function (response) {
                location.reload()
            })
        },
        updateCity: function(city) {
            let currApp = this;
            axios.put(`/cities`, city)
            .then(function (response) {
               currApp.getAllCities;
            })
            .catch(function () {
                 console.log("Error");
                 currApp.oldCity = '';
                 currApp.oldMessage = '';
                 currApp.editingCity = false,
                 currApp.editingMessage = false,
                 currApp.getAllCities;
                 currApp.error = 'Duplicate city error';
            })
        },
        deleteCity: function(city) {
            let currApp = this;
            currApp.cityId = city.id;
            axios.delete(`/cities/${currApp.cityId}`)
            .then(function (response) {
               location.reload()
            })
            .catch(function () {
                 currApp.error = "Delete Error";
            })
        },
        editCityEnter (city) {
            let currApp = this;
            currApp.oldCity = city.city;
            currApp.editingCity = true;
        },
        editCityCancel (city) {
            let currApp = this;
            city.city = currApp.oldCity;
            currApp.editingCity = false;
        },
        editCitySave (city) {
            let currApp = this;
            currApp.updateCity(city);
            currApp.editingCity = false;
        },
        editMessageEnter (city) {
            let currApp = this;
            currApp.oldMessage = city.message;
            currApp.editingMessage = true;
        },
        editMessageCancel (city) {
            let currApp = this;
            city.message = currApp.oldMessage;
            currApp.editingMessage = false;
        },
        editMessageSave (city) {
            let currApp = this;
            currApp.updateCity(city);
            currApp.editingMessage = false;
        }
    }
})
</script>
</body>
</html>